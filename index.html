<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Idea Helper</title>
  <style>
    :root { --bg:#0b0b0f; --fg:#f2f2f7; --muted:#a1a1aa; --card:#14141c; --accent:#7c93ff; --ok:#46d39a; --warn:#ffb84d; --bad:#ff6b6b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #222;position:sticky;top:0;background:linear-gradient(180deg, rgba(11,11,15,.97), rgba(11,11,15,.94));backdrop-filter:saturate(140%) blur(4px);z-index:3}
    header .left, header .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input, textarea, select{background:#0f0f16;color:var(--fg);border:1px solid #26263a;border-radius:12px;padding:12px 14px;outline:none;width:100%;transition:border-color .15s, box-shadow .15s;box-shadow:inset 0 0 0 1px #131320}
    input::placeholder, textarea::placeholder{color:var(--muted)}
    input:focus, textarea:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,147,255,.15), inset 0 0 0 1px #20203a}
    button{background:#1a1a24;color:var(--fg);border:1px solid #2a2a35;border-radius:12px;padding:10px 14px;cursor:pointer;transition:transform .05s ease, border-color .15s}
    button:hover{border-color:#3a3a48}
    button:active{transform:translateY(1px)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a2a35;background:#12121a}
    .accent{border-color:transparent;background:var(--accent);color:#0b0b0f;font-weight:600}
    .ok{background:var(--ok);color:#052014;border-color:transparent}
    .warn{background:var(--warn);color:#2a1b00;border-color:transparent}
    .bad{background:var(--bad);color:#2a0000;border-color:transparent}
    .app{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:12px}
    @media (max-width: 1000px){ .app{grid-template-columns:1fr} .sidebar{order:2} }
    .card{background:var(--card);border:1px solid #1e1e29;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px #141422}
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .list{max-height:65vh;overflow:auto}
    .row{padding:10px 12px;border-bottom:1px solid #191926;display:flex;gap:8px;align-items:center}
    .row:hover{background:#11111a}
    .row .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row small{color:var(--muted)}
    .row.active{background:#0e1120;border-left:3px solid var(--accent)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid #191926;position:sticky;top:0;background:linear-gradient(180deg, rgba(11,11,15,.95), rgba(11,11,15,.92));backdrop-filter:saturate(140%) blur(4px);z-index:2}
    .main{padding:20px;max-width:1200px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;align-items:start}
    .grid textarea{min-height:140px;resize:vertical}
    .full{grid-column:1/-1}
    label{display:flex;flex-direction:column;gap:8px;font-weight:600;color:#e6e6ee}
    label small{font-weight:400;color:var(--muted)}
    .status{font-size:12px;color:var(--muted)}
    .tag{font-size:11px;border:1px solid #2a2a35;border-radius:999px;padding:2px 8px;color:var(--muted)}
    .kbd{border:1px solid #333;background:#111;padding:2px 6px;border-radius:6px;font-size:12px;color:#ddd}
    .footer{padding:10px 14px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Idea Helper</strong>
      <span class="status" id="status">ready</span>
      <span class="tag">space: <span id="count">0</span> ideas</span>
      <span class="tag">unsaved: <span id="unsaved">0</span></span>
    </div>
    <div class="right">
      <input id="endpoint" size="38" placeholder="npoint endpoint (e.g. https://api.npoint.io/cd1184765c36929f0b34)" />
      <input id="apikey" size="18" placeholder="X-Api-Key (optional for write)" />
      <button id="saveCfg" class="pill">Save config</button>
      <button id="load" class="pill">Load</button>
      <button id="save" class="accent">Save to npoint ⌘S</button>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="card">
        <div class="toolbar">
          <input id="q" placeholder="search (title/notes)" />
          <select id="catFilter"><option value="">all categories</option></select>
          <button id="shuffle">Shuffle ␣</button>
        </div>
        <div class="list" id="list"></div>
      </div>
      <div class="card" style="padding:10px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="new">New idea N</button>
          <button id="duplicate">Duplicate</button>
          <button id="archive" class="warn">Archive</button>
          <button id="delete" class="bad">Delete</button>
        </div>
        <hr style="border:none;border-top:1px solid #191926;margin:10px 0"/>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="file" id="file" accept="application/json" />
          <button id="importBtn">Import JSON → local</button>
          <button id="exportBtn">Export JSON</button>
        </div>
        <p class="status">Tip: Seed your npoint bin with the exported JSON, then use your bin's Secret as <code>X-Api-Key</code> for writes.</p>
      </div>
    </aside>

    <main class="card">
      <div class="toolbar">
        <button id="prev">◀ Prev</button>
        <button id="next">Next ▶</button>
        <button id="pick" class="ok">Morning pick</button>
        <span class="status">Shortcuts: <span class="kbd">Space</span> shuffle · <span class="kbd">N</span> new · <span class="kbd">⌘/Ctrl+S</span> save</span>
      </div>
      <div class="main">
        <div class="grid">
          <label class="full">Title
            <input id="title" placeholder="Idea title" />
          </label>
          <label>Category
            <input id="category" placeholder="game/product/app/movie/..." />
          </label>
          <label>Link
            <input id="link" placeholder="https://..." />
          </label>
          <label>Inflection point
            <input id="infl" placeholder="what makes it pop?" />
          </label>
          <label class="full">Elevator pitch <small>One or two sentences that captures the hook</small>
            <textarea id="pitch" placeholder="Short, compelling pitch..."></textarea>
          </label>
          <label class="full">Notes <small>Anything freeform: variants, risks, references</small>
            <textarea id="notes" placeholder="Freeform notes..."></textarea>
          </label>
          <label>Problem <small>The pain it removes</small>
            <textarea id="problem" placeholder="What hurts today?" style="min-height:110px"></textarea>
          </label>
          <label>Monetization <small>Pricing, funnel, wedge</small>
            <textarea id="money" placeholder="How does it make money?" style="min-height:110px"></textarea>
          </label>
          <label class="full">Image URL
            <input id="image" placeholder="https://... (optional)" />
          </label>
        </div>
      </div>
      <div class="footer">
        <div>id: <code id="rid">—</code> · <span id="archivedTag" class="tag" style="display:none">archived</span></div>
        <div><a id="openLink" href="#" target="_blank">open link</a></div>
      </div>
    </main>
  </div>

  <script>
  // ---- utilities ----
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = (s) => (crypto && crypto.randomUUID ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10));

  const cfg = {
    endpoint: localStorage.getItem('ih.endpoint') || 'https://api.npoint.io/cd1184765c36929f0b34',
    apikey: localStorage.getItem('ih.apikey') || ''
  };

  const els = {
    endpoint: $('#endpoint'), apikey: $('#apikey'), saveCfg: $('#saveCfg'),
    load: $('#load'), save: $('#save'), list: $('#list'), q: $('#q'),
    catFilter: $('#catFilter'), shuffle: $('#shuffle'), pick: $('#pick'),
    prev: $('#prev'), next: $('#next'), newBtn: $('#new'), dup: $('#duplicate'),
    archive: $('#archive'), del: $('#delete'), file: $('#file'), importBtn: $('#importBtn'), exportBtn: $('#exportBtn'),
    // form fields
    rid: $('#rid'), title: $('#title'), category: $('#category'), link: $('#link'), infl: $('#infl'),
    pitch: $('#pitch'), notes: $('#notes'), problem: $('#problem'), money: $('#money'), image: $('#image'),
    status: $('#status'), count: $('#count'), unsaved: $('#unsaved'), archivedTag: $('#archivedTag'), openLink: $('#openLink')
  };

  els.endpoint.value = cfg.endpoint; els.apikey.value = cfg.apikey;

  let data = { ideas: [] };
  let idx = -1; // current index in filtered view
  let filteredIdxs = []; // mapping to data.ideas indexes
  let dirty = new Set();

  function setStatus(s){ els.status.textContent = s; }
  function refreshCounts(){ els.count.textContent = data.ideas.length; els.unsaved.textContent = dirty.size; }

  function normalizeIdea(p){
    return {
      id: p.id || uid(),
      title: (p.title||'').trim(),
      category: (p.category||'').trim() || null,
      pitch: p.pitch||null,
      notes: p.notes||null,
      problem: p.problem||null,
      monetization: p.monetization||p.money||null,
      link: p.link||null,
      image: p.image||null,
      inflection_point: p.inflection_point||p.infl||null,
      createdAt: p.createdAt || Math.floor(Date.now()/1000),
      updatedAt: Math.floor(Date.now()/1000),
      archived: !!p.archived,
      score: Number.isFinite(p.score)? p.score : 0
    };
  }

  function renderList(){
    const q = els.q.value.toLowerCase().trim();
    const cat = els.catFilter.value;
    const nodes = [];
    filteredIdxs = [];

    // categories
    const cats = new Set(['']);
    data.ideas.forEach(it => { if(it.category) cats.add(it.category); });
    const prevSel = els.catFilter.value; els.catFilter.innerHTML = ''; cats.forEach(c=>{
      const opt = document.createElement('option'); opt.value = c; opt.textContent = c || 'all categories'; els.catFilter.appendChild(opt);
    }); els.catFilter.value = prevSel;

    data.ideas.forEach((it, i) => {
      if(cat && it.category !== cat) return;
      if(q && !(`${it.title} ${it.notes||''}`.toLowerCase().includes(q))) return;
      filteredIdxs.push(i);
      const row = document.createElement('div'); row.className = 'row'; row.dataset.i = String(filteredIdxs.length-1);
      if(idx === filteredIdxs.length-1) row.classList.add('active');
      row.innerHTML = `<div class=title>${escapeHtml(it.title||'(untitled)')}</div><small>${it.category||''}</small>`;
      row.onclick = () => { idx = Number(row.dataset.i); loadCurrent(); };
      nodes.push(row);
    });
    els.list.replaceChildren(...nodes);
    if(idx < 0 && filteredIdxs.length){ idx = 0; }
    if(filteredIdxs.length && idx >= filteredIdxs.length){ idx = filteredIdxs.length-1; }
    loadCurrent(false);
  }

  function loadCurrent(scrollIntoView=true){
    if(idx < 0 || !filteredIdxs.length){ clearForm(); return; }
    const realIndex = filteredIdxs[idx];
    const it = data.ideas[realIndex];
    els.rid.textContent = it.id;
    els.title.value = it.title||'';
    els.category.value = it.category||'';
    els.link.value = it.link||'';
    els.infl.value = it.inflection_point||'';
    els.pitch.value = it.pitch||'';
    els.notes.value = it.notes||'';
    els.problem.value = it.problem||'';
    els.money.value = it.monetization||'';
    els.image.value = it.image||'';
    els.archivedTag.style.display = it.archived ? 'inline-block' : 'none';
    els.openLink.href = it.link || '#';
    $$('.row').forEach((n,j)=>{ n.classList.toggle('active', j===idx); if(j===idx && scrollIntoView) n.scrollIntoView({block:'nearest'}); });
  }

  function readForm(){
    return normalizeIdea({
      id: els.rid.textContent==='—'? undefined : els.rid.textContent,
      title: els.title.value,
      category: els.category.value,
      link: els.link.value,
      inflection_point: els.infl.value,
      pitch: els.pitch.value,
      notes: els.notes.value,
      problem: els.problem.value,
      monetization: els.money.value,
      image: els.image.value,
      archived: (data.ideas[filteredIdxs[idx]]||{}).archived || false,
      createdAt: (data.ideas[filteredIdxs[idx]]||{}).createdAt
    });
  }

  function updateCurrent(){
    if(idx < 0 || !filteredIdxs.length) return;
    const realIndex = filteredIdxs[idx];
    data.ideas[realIndex] = readForm();
    dirty.add(data.ideas[realIndex].id);
    refreshCounts();
    renderList();
  }

  function clearForm(){ els.rid.textContent='—'; ['title','category','link','infl','pitch','notes','problem','money','image'].forEach(k=>els[k].value=''); els.archivedTag.style.display='none'; }

  function newIdea(){
    const it = normalizeIdea({ title: '', category: '', notes: '' });
    data.ideas.unshift(it); // add to top
    idx = 0; filteredIdxs = [0, ...filteredIdxs.map(i=>i+1)];
    renderList();
    dirty.add(it.id); refreshCounts();
    els.title.focus();
  }

  function duplicateIdea(){ if(idx<0) return; const realIndex = filteredIdxs[idx]; const it = data.ideas[realIndex]; const copy = normalizeIdea({...it, id: undefined, title: it.title+" (copy)"}); data.ideas.splice(realIndex+1,0,copy); renderList(); dirty.add(copy.id); refreshCounts(); }
  function archiveIdea(){ if(idx<0) return; const realIndex = filteredIdxs[idx]; data.ideas[realIndex].archived = !data.ideas[realIndex].archived; data.ideas[realIndex].updatedAt = Math.floor(Date.now()/1000); renderList(); dirty.add(data.ideas[realIndex].id); refreshCounts(); }
  function deleteIdea(){ if(idx<0) return; const realIndex = filteredIdxs[idx]; const id = data.ideas[realIndex].id; if(!confirm('Delete this idea?')) return; data.ideas.splice(realIndex,1); idx = Math.max(0, idx-1); renderList(); dirty.delete(id); refreshCounts(); }

  function shuffle(){ if(!filteredIdxs.length) return; idx = Math.floor(Math.random()*filteredIdxs.length); loadCurrent(); }

  async function loadFromNpoint(){
    try{
      setStatus('loading…');
      const res = await fetch(cfg.endpoint, { cache: 'no-store' });
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      const json = await res.json();
      data = { ideas: Array.isArray(json.ideas) ? json.ideas.map(normalizeIdea) : Array.isArray(json) ? json.map(normalizeIdea) : [] };
      dirty.clear(); refreshCounts(); idx = -1; renderList(); setStatus('loaded');
    }catch(e){ console.error(e); setStatus('load failed; starting with empty space'); data = { ideas: [] }; renderList(); }
  }

  async function saveToNpoint(){
    try{
      setStatus('saving…');
      const body = JSON.stringify({ ideas: data.ideas }, null, 2);
      const headers = { 'Content-Type':'application/json' };
      if(cfg.apikey) headers['X-Api-Key'] = cfg.apikey; // npoint bin Secret
      const res = await fetch(cfg.endpoint, { method:'PUT', headers, body });
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      dirty.clear(); refreshCounts(); setStatus('saved ✓');
    }catch(e){ console.error(e); setStatus('save failed: '+e.message); alert('Save failed. Did you set the correct endpoint and X-Api-Key from your npoint bin?'); }
  }

  function exportJSON(){ const blob = new Blob([JSON.stringify({ideas:data.ideas}, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ideas.json'; a.click(); URL.revokeObjectURL(a.href); }
  function importJSON(file){ const r=new FileReader(); r.onload=() => { try{ const j=JSON.parse(r.result); const arr = Array.isArray(j.ideas)? j.ideas : Array.isArray(j)? j : []; arr.forEach(x=>data.ideas.push(normalizeIdea(x))); renderList(); setStatus('imported'); refreshCounts(); }catch(e){ alert('Invalid JSON'); } }; r.readAsText(file); }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  // ---- wire up ----
  els.saveCfg.onclick = ()=>{ cfg.endpoint = els.endpoint.value.trim(); cfg.apikey = els.apikey.value.trim(); localStorage.setItem('ih.endpoint', cfg.endpoint); localStorage.setItem('ih.apikey', cfg.apikey); setStatus('config saved'); };
  els.load.onclick = loadFromNpoint;
  els.save.onclick = saveToNpoint;
  els.shuffle.onclick = shuffle;
  els.pick.onclick = shuffle;
  els.prev.onclick = ()=>{ if(idx>0){ idx--; loadCurrent(); } };
  els.next.onclick = ()=>{ if(idx<filteredIdxs.length-1){ idx++; loadCurrent(); } };
  els.newBtn.onclick = newIdea;
  els.dup.onclick = duplicateIdea;
  els.archive.onclick = archiveIdea;
  els.del.onclick = deleteIdea;
  els.exportBtn.onclick = exportJSON;
  els.importBtn.onclick = ()=>{ if(els.file.files[0]) importJSON(els.file.files[0]); else alert('Choose a JSON file to import first.'); };

  // form change listeners
  ['title','category','link','infl','pitch','notes','problem','money','image'].forEach(k=>{
    els[k].addEventListener('input', ()=>{ updateCurrent(); });
  });

  // list filters
  els.q.addEventListener('input', renderList);
  els.catFilter.addEventListener('change', ()=>{ idx=0; renderList(); });

  // keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){ e.preventDefault(); shuffle(); }
    if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveToNpoint(); }
    if(!e.metaKey && !e.ctrlKey && e.key.toLowerCase()==='n' && document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA'){ e.preventDefault(); newIdea(); }
  });

  // initial
  refreshCounts(); renderList(); setStatus('ready');
  loadFromNpoint();
  </script>
</body>
</html>
