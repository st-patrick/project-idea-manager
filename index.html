<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="logo.png">
  <link rel="manifest" href="/app.webmanifest">

  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>Idea Helper</title>
  <style>
    :root { 
      /* Light mode colors */
      --bg: #ffffff; 
      --fg: #1a1a1a; 
      --muted: #6b7280; 
      --card: #f8fafc; 
      --accent: #3b82f6; 
      --ok: #10b981; 
      --warn: #f59e0b; 
      --bad: #ef4444;
      --border: #e5e7eb;
      --border-light: #f3f4f6;
      --input-bg: #ffffff;
      --input-border: #d1d5db;
      --input-shadow: rgba(59, 130, 246, 0.15);
      --button-bg: #f9fafb;
      --button-border: #d1d5db;
      --button-hover: #e5e7eb;
      --card-shadow: rgba(0, 0, 0, 0.1);
      --theme-color: #3b82f6;
      --row-active-bg: var(--accent);
    }

    @media (prefers-color-scheme: dark) {
      :root { 
        /* Dark mode colors */
        --bg: #0b0b0f; 
        --fg: #f2f2f7; 
        --muted: #a1a1aa; 
        --card: #14141c; 
        --accent: #7c93ff; 
        --ok: #46d39a; 
        --warn: #ffb84d; 
        --bad: #ff6b6b;
        --border: #222;
        --border-light: #191926;
        --input-bg: #0f0f16;
        --input-border: #26263a;
        --input-shadow: rgba(124, 147, 255, 0.15);
        --button-bg: #1a1a24;
        --button-border: #2a2a35;
        --button-hover: #3a3a48;
        --card-shadow: rgba(0, 0, 0, 0.35);
        --theme-color: #7c93ff;
        --row-active-bg: #0e1120;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    header .left, header .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0}
    input, textarea, select{background:var(--input-bg);color:var(--fg);border:1px solid var(--input-border);border-radius:12px;padding:12px 14px;outline:none;width:100%;transition:border-color .15s, box-shadow .15s;box-shadow:inset 0 0 0 1px var(--input-shadow)}
    input::placeholder, textarea::placeholder{color:var(--muted)}
    input:focus, textarea:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--input-shadow)}
    button{background:var(--button-bg);color:var(--fg);border:1px solid var(--button-border);border-radius:12px;padding:10px 14px;cursor:pointer;transition:transform .05s ease, background-color .15s, border-color .15s}
    button:hover{background:var(--button-hover);border-color:var(--button-border)}
    button:active{transform:translateY(1px)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--button-border);background:var(--button-bg)}
    .accent{border-color:transparent;background:var(--accent);color:var(--bg);font-weight:600}
    .ok{background:var(--ok);color:var(--bg);border-color:transparent}
    .warn{background:var(--warn);color:var(--bg);border-color:transparent}
    .bad{background:var(--bad);color:var(--bg);border-color:transparent}
    .app{display:grid;grid-template-columns:minmax(0,320px) minmax(0,1fr);gap:14px;padding:12px;max-width:1400px;margin:0 auto}
    @media (max-width:960px){ .app{grid-template-columns:1fr} .sidebar{order:2} }
    .card{background:var(--card);border:1px solid var(--border-light);border-radius:18px;box-shadow:0 10px 30px var(--card-shadow), inset 0 0 0 1px var(--border-light)}
    .sidebar{display:flex;flex-direction:column;gap:12px;min-width:0}
    .list{max-height:65vh;overflow:auto}
    .row{padding:10px 12px;border-bottom:1px solid var(--border-light);display:flex;gap:8px;align-items:center;min-width:0}
    .row:hover{background:var(--button-hover)}
    .row .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
    .row small{color:var(--muted)}
    .row.active{background:var(--row-active-bg);color:var(--bg);border-left:3px solid var(--accent)}
    .row.active small{color:var(--bg);opacity:0.8}
    
    @media (prefers-color-scheme: dark) {
      .row.active{color:var(--fg)}
      .row.active small{color:var(--muted)}
    }
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--border-light)}
    .toolbar .spacer{flex:1}
    .main{padding:20px;max-width:1200px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;align-items:start}
    .grid textarea{min-height:140px;resize:vertical}
    .full{grid-column:1/-1}
    label{display:flex;flex-direction:column;gap:8px;font-weight:600;color:var(--fg)}
    label small{font-weight:400;color:var(--muted)}
    .status{font-size:12px;color:var(--muted)}
    .tag{font-size:11px;border:1px solid var(--button-border);border-radius:999px;padding:2px 8px;color:var(--muted)}
    .kbd{border:1px solid var(--button-border);background:var(--button-bg);padding:2px 6px;border-radius:6px;font-size:12px;color:var(--fg)}
    .footer{padding:10px 14px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    a{color:var(--accent);text-decoration:none}

    /* Favorite heart button */
    .heart{border-color:var(--button-border);background:var(--button-bg)}
    .heart[data-on="true"]{background:var(--bad);border-color:var(--bad)}
    .heart svg{display:block;width:18px;height:18px}
    .heart[data-on="true"] svg path{fill:var(--bg)}
    .heart[data-on="false"] svg path{fill:var(--muted)}
    .heart:focus{outline:2px solid var(--input-shadow); outline-offset:2px}

    /* Favorites-only toggle styling */
    .pill.toggle[data-on="true"]{background:var(--accent);color:var(--bg);border-color:transparent}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Idea Helper</strong>
      <span class="status" id="status">ready</span>

      <!-- replace this: <span class="tag">space: <span id="count">0</span> ideas</span> -->
      <span class="tag">all: <span id="countTotal">0</span></span>
      <span class="tag">active: <span id="countActive">0</span></span>
      <span class="tag">archived: <span id="countArchived">0</span></span>
      <span class="tag">&#10084;&#65039;: <span id="countFav">0</span></span>
      <span class="tag">mode: <span id="mode">remote</span></span>

      <span class="tag">mode: <span id="mode">remote</span></span>
      <a class="tip" href="https://www.paypal.com/paypalme/PatrickReinbold" target="_blank" rel="noopener noreferrer" title="tip jar">&#128151; tip jar</a>
    </div>
    <div class="right">
      <button id="save" class="accent">Save</button>
      <span class="tag">unsaved: <span id="unsaved">0</span></span>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="card">
        <div class="toolbar">
          <input id="q" placeholder="search (title/notes)" />
          <select id="catFilter"><option value="">all categories</option></select>
          <button id="favOnly" class="pill toggle" data-on="false" title="Show favorites only">&#10084;&#65039; favorites</button>
          <button id="showArchived" class="pill toggle" data-on="false" title="Show archived">
            &#128065;&#8416; archived
          </button>
        </div>
        <div class="list" id="list"></div>
      </div>
      <div class="card" style="padding:10px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="new">New idea N</button>
          <button id="duplicate">Duplicate</button>
          <button id="archive" class="warn">Archive</button>
          <button id="delete" class="bad">Delete</button>
        </div>
        <hr style="border:none;border-top:1px solid #191926;margin:10px 0"/>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="file" id="file" accept="application/json" />
          <button id="importBtn">Import JSON</button>
          <button id="exportBtn">Export JSON</button>
        </div>
      </div>
    </aside>

    <main class="card">
      <div class="toolbar">
        <button id="pick" class="ok">Random pick</button>
        <div class="spacer"></div>
        <!-- Favorite heart (top-right of form) -->
        <button id="favBtn" class="heart" title="Toggle favorite" aria-pressed="false" data-on="false">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s-6.716-3.83-9.066-7.086C1.06 11.64 2.02 8.5 4.9 7.6c1.86-.59 3.48.2 4.6 1.38 1.12-1.18 2.74-1.97 4.6-1.38 2.88.9 3.84 4.04 1.97 6.314C18.716 17.17 12 21 12 21z"/></svg>
        </button>
      </div>
      <div class="main">
        <div class="grid">
          <label class="full">Title
            <input id="title" placeholder="Idea title" />
          </label>
          <label>Category
            <input id="category" placeholder="game/product/app/movie/..." />
          </label>
          <label>Link
            <input id="link" placeholder="https://..." />
          </label>
          <label>Inflection point
            <input id="infl" placeholder="what makes it pop?" />
          </label>
          <label class="full">Elevator pitch <small>One or two sentences that captures the hook</small>
            <textarea id="pitch" placeholder="Short, compelling pitch..."></textarea>
          </label>
          <label class="full">Notes <small>Anything freeform: variants, risks, references</small>
            <textarea id="notes" placeholder="Freeform notes..."></textarea>
          </label>
          <label>Problem <small>The pain it removes</small>
            <textarea id="problem" placeholder="What hurts today?" style="min-height:110px"></textarea>
          </label>
          <label>Monetization <small>Pricing, funnel, wedge</small>
            <textarea id="money" placeholder="How does it make money?" style="min-height:110px"></textarea>
          </label>
          <label class="full">Image URL
            <input id="image" placeholder="https://... (optional)" />
          </label>
        </div>
      </div>
      <div class="footer">
        <div>id: <code id="rid"></code> <span id="archivedTag" class="tag" style="display:none; margin-left:10px">archived</span></div>
      </div>
    </main>
  </div>

  <!-- Settings footer -->
  <header>
    <div class="right">
      <input id="endpoint" size="38" placeholder="npoint endpoint (e.g. https://api.npoint.io/123456)" />
      <input id="apikey" size="18" placeholder="X-Api-Key (optional for write)" />
      <button id="saveCfg" class="pill">Save config</button>
      <button id="load" class="pill">Load</button>
    </div>
  </header>

  <script>
  // ---- Theme management ----
  function updateThemeColor() {
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const themeColor = isDark ? '#7c93ff' : '#3b82f6';
    
    // Update theme-color meta tag
    const themeColorMeta = document.querySelector('meta[name="theme-color"]');
    if (themeColorMeta) {
      themeColorMeta.content = themeColor;
    }
    
    // Update CSS custom property for potential JS usage
    document.documentElement.style.setProperty('--current-theme-color', themeColor);
  }

  // Initialize theme color
  updateThemeColor();

  // Listen for system theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateThemeColor);

  // ---- utilities ----
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = () => (crypto && crypto.randomUUID ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10));
  const nowSec = () => Math.floor(Date.now()/1000);

  // config
  const cfg = {
    endpoint: localStorage.getItem('ih.endpoint') || 'https://api.npoint.io/cd1184765c36929f0b34',
    apikey: localStorage.getItem('ih.apikey') || ''
  };

  const STORAGE_KEY='ih.local.ideas.v1';
  function setMode(m){ try{ localStorage.setItem('ih.mode', m); }catch(e){} const mt=$('#mode'); if(mt) mt.textContent=m; }
  function getMode(){ try{ return localStorage.getItem('ih.mode')||'remote'; }catch(e){ return 'remote'; } }

  // elements
  const els = {
    endpoint: $('#endpoint'), apikey: $('#apikey'), saveCfg: $('#saveCfg'),
    load: $('#load'), save: $('#save'), list: $('#list'), q: $('#q'),
    catFilter: $('#catFilter'), shuffle: $('#shuffle'), pick: $('#pick'),
    prev: $('#prev'), next: $('#next'), newBtn: $('#new'), dup: $('#duplicate'),
    archive: $('#archive'), del: $('#delete'), file: $('#file'), importBtn: $('#importBtn'), exportBtn: $('#exportBtn'),
    rid: $('#rid'), title: $('#title'), category: $('#category'), link: $('#link'), infl: $('#infl'),
    pitch: $('#pitch'), notes: $('#notes'), problem: $('#problem'), money: $('#money'), image: $('#image'),
    status: $('#status'), count: $('#count'), unsaved: $('#unsaved'), archivedTag: $('#archivedTag'), mode: $('#mode'),
    favBtn: $('#favBtn'), favOnly: $('#favOnly'),
    showArchived: $('#showArchived'),
    countTotal: $('#countTotal'), countActive: $('#countActive'),
    countArchived: $('#countArchived'), countFav: $('#countFav')    
  };
  if(els.endpoint) els.endpoint.value = cfg.endpoint;
  if(els.apikey) els.apikey.value = cfg.apikey;

  // ---------- DATA SHAPE ----------
  // Internal canonical fields:
  // { id, title, category, pitch, notes, problem, monetization, link, image, inflection_point, createdAt, updatedAt, archived, score, fav }
  //
  // Compact save keys (future payload):
  // { id, t, c, p, n, pr, m, l, i, ip, ca, ua, a, s, f }
  //  - omit keys if undefined/null/empty string/false/0 (except id, t)

  function expandIdea(raw){
    const compact = Object.prototype.hasOwnProperty.call(raw, 't') || Object.prototype.hasOwnProperty.call(raw, 'ca');
    if(compact){
      return {
        id: raw.id || uid(),
        title: raw.t ?? '',
        category: raw.c ?? null,
        pitch: raw.p ?? null,
        notes: raw.n ?? null,
        problem: raw.pr ?? null,
        monetization: raw.m ?? null,
        link: raw.l ?? null,
        image: raw.i ?? null,
        inflection_point: raw.ip ?? null,
        createdAt: raw.ca || nowSec(),
        updatedAt: raw.ua || nowSec(),
        archived: !!raw.a,
        score: Number.isFinite(raw.s) ? raw.s : 0,
        fav: !!raw.f
      };
    } else {
      return {
        id: raw.id || uid(),
        title: raw.title ?? '',
        category: raw.category ?? null,
        pitch: raw.pitch ?? null,
        notes: raw.notes ?? null,
        problem: raw.problem ?? null,
        monetization: raw.monetization ?? raw.money ?? null,
        link: raw.link ?? null,
        image: raw.image ?? null,
        inflection_point: raw.inflection_point ?? raw.infl ?? null,
        createdAt: raw.createdAt || nowSec(),
        updatedAt: raw.updatedAt || nowSec(),
        archived: !!raw.archived,
        score: Number.isFinite(raw.score) ? raw.score : 0,
        fav: !!raw.fav
      };
    }
  }

  function normalizeIdea(p){
    return {
      id: p.id || uid(),
      title: (p.title ?? ''),
      category: (p.category ?? null),
      pitch: p.pitch ?? null,
      notes: p.notes ?? null,
      problem: p.problem ?? null,
      monetization: (p.monetization ?? p.money ?? null),
      link: p.link ?? null,
      image: p.image ?? null,
      inflection_point: (p.inflection_point ?? p.infl ?? null),
      createdAt: p.createdAt || nowSec(),
      updatedAt: nowSec(),
      archived: !!p.archived,
      score: Number.isFinite(p.score)? p.score : 0,
      fav: !!p.fav
    };
  }

  // Build compact object and drop empties
  function toCompactClean(it){
    const o = {
      id: it.id,
      t: (it.title ?? '').trim(),
      c: tidyStr(it.category),
      p: tidyStr(it.pitch),
      n: tidyStr(it.notes),
      pr: tidyStr(it.problem),
      m: tidyStr(it.monetization),
      l: tidyStr(it.link),
      i: tidyStr(it.image),
      ip: tidyStr(it.inflection_point),
      ca: it.createdAt || nowSec(),
      ua: nowSec(),
      a: it.archived ? 1 : undefined,
      s: it.score && it.score !== 0 ? it.score : undefined,
      f: it.fav ? 1 : undefined
    };
    Object.keys(o).forEach(k=>{
      const v = o[k];
      if (v === undefined || v === null || (typeof v === 'string' && v.trim() === '')) delete o[k];
    });
    return o;
  }
  function tidyStr(v){ if(v==null) return undefined; const s=String(v).trim(); return s? s: undefined; }

  // ---------- STATE ----------
  let data = { ideas: [] };
  let idx = -1;
  let filteredIdxs = [];
  let dirty = new Set();
  let recentPicks = new Set(); // Track recent random picks to avoid repetition

  function setStatus(s){ if(els.status) els.status.textContent = s; }
  function refreshCounts(){
    const total = data.ideas.length;
    const archived = data.ideas.filter(it => it.archived).length;
    const fav = data.ideas.filter(it => it.fav).length;
    const active = total - archived;

    if(els.countTotal) els.countTotal.textContent = total;
    if(els.countActive) els.countActive.textContent = active;
    if(els.countArchived) els.countArchived.textContent = archived;
    if(els.countFav) els.countFav.textContent = fav;
    if(els.unsaved) els.unsaved.textContent = dirty.size;
  }

  function refreshArchivedToggle(){
    if(!els.showArchived) return;
    const on = els.showArchived.dataset.on === 'true';
    // open eye when showing archived, closed/slashed eye when hiding archived
    els.showArchived.innerHTML = on ? '&#128065; archived' : '&#8416; archived';
    els.showArchived.setAttribute('aria-pressed', on ? 'true' : 'false');
  }



  function renderList(){
    const q = (els.q && els.q.value || '').toLowerCase().trim();
    const cat = els.catFilter ? els.catFilter.value : '';
    const favOnly = els.favOnly ? (els.favOnly.dataset.on === 'true') : false;

    const nodes = [];
    filteredIdxs = [];

    // categories
    if(els.catFilter){
      const cats = new Set(['']);
      data.ideas.forEach(it => { if(it.category) cats.add(it.category); });
      const prevSel = els.catFilter.value;
      els.catFilter.innerHTML = '';
      cats.forEach(c=>{
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c || 'all categories'; els.catFilter.appendChild(opt);
      });
      els.catFilter.value = prevSel;
    }

    // Check if archived items should be shown
    // Special rule: if a category is selected, show all items including archived
    const showArchived = cat ? true : (els.showArchived ? (els.showArchived.dataset.on === 'true') : false);
    
    data.ideas.forEach((it, i) => {
      if(!showArchived && it.archived) return; 
      if(cat && it.category !== cat) return;
      if(favOnly && !it.fav) return;
      if(q && !(`${it.title} ${it.notes||''}`.toLowerCase().includes(q))) return;
      filteredIdxs.push(i);
      const row = document.createElement('div'); row.className = 'row'; row.dataset.i = String(filteredIdxs.length-1);
      if(idx === filteredIdxs.length-1) row.classList.add('active');
      const heart = it.fav ? ' &#10084;&#65039;' : '';
      row.innerHTML = `<div class="title">${escapeHtml(it.title||'(untitled)')}${heart}</div><small>${it.category||''}</small>`;
      row.onclick = () => { idx = Number(row.dataset.i); loadCurrent(); };
      nodes.push(row);
    });
    if(els.list){ els.list.replaceChildren(...nodes); }
    if(idx < 0 && filteredIdxs.length){ idx = 0; }
    if(filteredIdxs.length && idx >= filteredIdxs.length){ idx = filteredIdxs.length-1; }
    
    // Clear recent picks when the filtered list changes significantly
    // This prevents stale indices from affecting the random selection
    recentPicks.clear();
    
    loadCurrent(false);
  }

  function loadCurrent(scrollIntoView=true){
    if(idx < 0 || !filteredIdxs.length){ clearForm(); return; }
    const realIndex = filteredIdxs[idx];
    const it = data.ideas[realIndex];
    if(els.rid) els.rid.textContent = it.id || '';
    if(els.title) els.title.value = it.title||'';
    if(els.category) els.category.value = it.category||'';
    if(els.link) els.link.value = it.link||'';
    if(els.infl) els.infl.value = it.inflection_point||'';
    if(els.pitch) els.pitch.value = it.pitch||'';
    if(els.notes) els.notes.value = it.notes||'';
    if(els.problem) els.problem.value = it.problem||'';
    if(els.money) els.money.value = it.monetization||'';
    if(els.image) els.image.value = it.image||'';
    if(els.archivedTag) els.archivedTag.style.display = it.archived ? 'inline-block' : 'none';
    if(els.favBtn){
      els.favBtn.dataset.on = it.fav ? 'true' : 'false';
      els.favBtn.setAttribute('aria-pressed', it.fav ? 'true' : 'false');
    }
    $$('.row').forEach((n,j)=>{ n.classList.toggle('active', j===idx); if(j===idx && scrollIntoView) n.scrollIntoView({block:'nearest'}); });
  }

  function readForm(){
    const base = (filteredIdxs[idx] != null) ? (data.ideas[filteredIdxs[idx]] || {}) : {};
    return normalizeIdea({
      id: els.rid && els.rid.textContent ? els.rid.textContent : base.id,
      title: els.title ? els.title.value : base.title || '',
      category: els.category ? els.category.value : base.category || '',
      link: els.link ? els.link.value : base.link || '',
      inflection_point: els.infl ? els.infl.value : base.inflection_point || '',
      pitch: els.pitch ? els.pitch.value : base.pitch || '',
      notes: els.notes ? els.notes.value : base.notes || '',
      problem: els.problem ? els.problem.value : base.problem || '',
      monetization: els.money ? els.money.value : base.monetization || '',
      image: els.image ? els.image.value : base.image || '',
      archived: base.archived || false,
      createdAt: base.createdAt,
      score: base.score || 0,
      fav: base.fav || false
    });
  }

  function updateCurrent(){
    if(idx < 0 || !filteredIdxs.length) return;
    const realIndex = filteredIdxs[idx];
    data.ideas[realIndex] = readForm();
    dirty.add(data.ideas[realIndex].id);
    refreshCounts();
    if (document.activeElement !== els.title) renderList();
  }

  function clearForm(){ if(els.rid) els.rid.textContent=''; ['title','category','link','infl','pitch','notes','problem','money','image'].forEach(k=>{ if(els[k]) els[k].value=''; }); if(els.archivedTag) els.archivedTag.style.display='none'; if(els.favBtn){ els.favBtn.dataset.on='false'; els.favBtn.setAttribute('aria-pressed','false'); } }

  function newIdea(){
    const it = normalizeIdea({ title: '', category: '', notes: '' });
    data.ideas.unshift(it);
    idx = 0; filteredIdxs = [0, ...filteredIdxs.map(i=>i+1)];
    renderList();
    dirty.add(it.id); refreshCounts();
    if(els.title) els.title.focus();
  }

  function duplicateIdea(){
    if(idx<0) return;
    const realIndex = filteredIdxs[idx];
    const it = data.ideas[realIndex];
    const copy = normalizeIdea({ ...it, id: undefined, title: it.title+" (copy)" });
    data.ideas.splice(realIndex+1,0,copy);
    renderList();
    dirty.add(copy.id); refreshCounts();
  }
  function archiveIdea(){ if(idx<0) return; const realIndex = filteredIdxs[idx]; data.ideas[realIndex].archived = !data.ideas[realIndex].archived; data.ideas[realIndex].updatedAt = nowSec(); renderList(); dirty.add(data.ideas[realIndex].id); refreshCounts(); }
  function deleteIdea(){ if(idx<0) return; const realIndex = filteredIdxs[idx]; const id = data.ideas[realIndex].id; if(!confirm('Delete this idea?')) return; data.ideas.splice(realIndex,1); idx = Math.max(0, idx-1); renderList(); dirty.delete(id); refreshCounts(); }

  function toggleFav(){
    if(idx<0) return;
    const realIndex = filteredIdxs[idx];
    const it = data.ideas[realIndex];
    it.fav = !it.fav;
    it.updatedAt = nowSec();
    if(els.favBtn){
      els.favBtn.dataset.on = it.fav ? 'true' : 'false';
      els.favBtn.setAttribute('aria-pressed', it.fav ? 'true' : 'false');
    }
    dirty.add(it.id);
    refreshCounts();
    renderList();
  }

  function toggleFavOnly(){
    if(!els.favOnly) return;
    const on = els.favOnly.dataset.on === 'true';
    els.favOnly.dataset.on = on ? 'false' : 'true';
    renderList();
  }

  function randInt(n){
    if (n <= 0) return 0;
    const c = (self.crypto || self.msCrypto);
    if (c && c.getRandomValues) {
      const buf = new Uint32Array(1);
      const limit = Math.floor(0x100000000 / n) * n; // unbiased
      let r;
      do { c.getRandomValues(buf); r = buf[0]; } while (r >= limit);
      return r % n;
    }
    // fallback if not https/localhost
    return (Math.random() * n) | 0;
  }

  function getWeightedRandomIndex(availableIndices) {
    // Create a weighted list where items not recently picked have higher weight
    const weights = availableIndices.map(i => {
      const realIndex = filteredIdxs[i];
      const idea = data.ideas[realIndex];
      
      // Base weight of 1, lower for recently picked
      let weight = 1;
      if (recentPicks.has(i)) weight = Math.max(0.1, weight * 0.2); // Recently picked get much lower chance
      
      return weight;
    });
    
    // Calculate total weight
    const totalWeight = weights.reduce((sum, w) => sum + w, 0);
    if (totalWeight === 0) return availableIndices[randInt(availableIndices.length)];
    
    // Pick a random number between 0 and totalWeight
    const target = Math.random() * totalWeight;
    
    // Find the corresponding index
    let currentWeight = 0;
    for (let i = 0; i < availableIndices.length; i++) {
      currentWeight += weights[i];
      if (currentWeight >= target) {
        return availableIndices[i];
      }
    }
    
    // Fallback
    return availableIndices[availableIndices.length - 1];
  }

  function shuffle(){
    if (!filteredIdxs.length) return;
    
    // Check current filter states
    const cat = els.catFilter ? els.catFilter.value : '';
    const showArchived = cat ? true : (els.showArchived ? (els.showArchived.dataset.on === 'true') : false);
    const favOnly = els.favOnly ? (els.favOnly.dataset.on === 'true') : false;
    const availableIndices = [];
    
    for (let i = 0; i < filteredIdxs.length; i++) {
      const realIndex = filteredIdxs[i];
      const idea = data.ideas[realIndex];
      
      // Skip archived if not shown (unless category is selected)
      if (!showArchived && idea.archived) continue;
      
      // Special rule: when category is selected, pick from ALL items in that category
      if (cat) {
        // Category is selected - pick from all items in the filtered list
        availableIndices.push(i);
      } else {
        // No category selected - apply favorites filter logic
        if (favOnly) {
          // Favorites filter is active - only pick favorites
          if (idea.fav) {
            availableIndices.push(i);
          }
        } else {
          // Favorites filter is NOT active - only pick NON-favorites
          if (!idea.fav) {
            availableIndices.push(i);
          }
        }
      }
    }
    
    if (!availableIndices.length) return;
    
    // If we have many options, use weighted random, otherwise use simple random
    let newIdx;
    if (availableIndices.length >= 3) {
      newIdx = getWeightedRandomIndex(availableIndices);
    } else {
      newIdx = availableIndices[randInt(availableIndices.length)];
    }
    
    // Track this pick to avoid repetition
    recentPicks.add(newIdx);
    
    // Limit recent picks to avoid memory bloat and ensure we don't exclude too many
    const maxRecentPicks = Math.min(Math.floor(availableIndices.length / 3), 10);
    if (recentPicks.size > maxRecentPicks) {
      const recentArray = Array.from(recentPicks);
      recentPicks.clear();
      // Keep only the most recent picks
      recentArray.slice(-maxRecentPicks).forEach(i => recentPicks.add(i));
    }
    
    idx = newIdx;
    loadCurrent();
  }



  
  // --------- Remote / Local I/O ----------
  async function loadFromNpoint(){
    try{
      setStatus('loadingâ€¦');
      const res = await fetch(cfg.endpoint, { cache: 'no-store' });
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      const json = await res.json();
      const arr = Array.isArray(json.ideas) ? json.ideas : Array.isArray(json) ? json : [];
      data = { ideas: arr.map(x => normalizeIdea(expandIdea(x))) };
      dirty.clear(); refreshCounts(); idx = -1; renderList(); setStatus('loaded');
      return true;
    }catch(e){ console.error(e); setStatus('load failed; using local'); return false; }
  }

  async function saveToNpoint(compactPayload){
    try{
      setStatus('saving ...');
      const headers = { 'Content-Type':'application/json' };
      if(cfg.apikey) headers['Authorization'] = "Bearer " + cfg.apikey;
      const res = await fetch(cfg.endpoint, { method:'POST', headers, body: JSON.stringify(compactPayload) });
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      dirty.clear(); refreshCounts(); setStatus('saved!');
      return true;
    }catch(e){ console.error(e); setStatus('save failed - saved locally'); return false; }
  }

  async function loadData(){
    const ep = (cfg.endpoint||'').trim();
    if(ep){
      const ok = await loadFromNpoint();
      if(ok){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(compactify(data.ideas))); }catch(e){} setMode('remote'); return; }
    }
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : { ideas: [] };
      const arr = Array.isArray(parsed.ideas) ? parsed.ideas : Array.isArray(parsed) ? parsed : [];
      data = { ideas: arr.map(x => normalizeIdea(expandIdea(x))) };
    }catch(e){ data = { ideas: [] }; }
    dirty.clear(); refreshCounts(); idx=-1; renderList(); setStatus('loaded (local)'); setMode('local');
  }

  function compactify(ideas){ return { ideas: ideas.map(toCompactClean) }; }

  async function saveData(){
    if(!data.ideas.length){ setStatus('nothing to save'); return; }
    if(!dirty.size){ setStatus('no changes to save'); return; }

    const payload = compactify(data.ideas);
    const ep = (cfg.endpoint||'').trim();

    if(ep){
      const ok = await saveToNpoint(payload);
      if(ok){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){} setMode('remote'); return; }
    }
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){}
    setStatus('saved locally!'); setMode('local');
  }

  function exportJSON(){ const blob = new Blob([JSON.stringify(compactify(data.ideas), null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ideas.json'; a.click(); URL.revokeObjectURL(a.href); }
  function importJSON(file){ const r=new FileReader(); r.onload=() => { try{ const j=JSON.parse(r.result); const arr = Array.isArray(j.ideas)? j.ideas : Array.isArray(j)? j : []; arr.forEach(x=>data.ideas.push(normalizeIdea(expandIdea(x)))); renderList(); setStatus('imported'); refreshCounts(); }catch(e){ alert('Invalid JSON'); } }; r.readAsText(file); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  // wire up
  if(els.saveCfg){ els.saveCfg.onclick = ()=>{ cfg.endpoint = els.endpoint ? els.endpoint.value.trim() : cfg.endpoint; cfg.apikey = els.apikey ? els.apikey.value.trim() : cfg.apikey; try{ localStorage.setItem('ih.endpoint', cfg.endpoint); localStorage.setItem('ih.apikey', cfg.apikey);}catch(e){} setStatus('config saved'); }; }
  if(els.load){ els.load.onclick = loadData; }
  if(els.save){ els.save.onclick = saveData; }
  if(els.pick){ els.pick.onclick = shuffle; }
  if(els.newBtn){ els.newBtn.onclick = newIdea; }
  if(els.dup){ els.dup.onclick = duplicateIdea; }
  if(els.archive){ els.archive.onclick = archiveIdea; }
  if(els.del){ els.del.onclick = deleteIdea; }
  if(els.exportBtn){ els.exportBtn.onclick = exportJSON; }
  if(els.importBtn){ els.importBtn.onclick = ()=>{ if(els.file && els.file.files[0]) importJSON(els.file.files[0]); else alert('Choose a JSON file to import first.'); }; }
  if(els.favBtn){ els.favBtn.onclick = toggleFav; }
  if(els.favOnly){ els.favOnly.onclick = toggleFavOnly; }
  if(els.showArchived){
    els.showArchived.onclick = () => {
      els.showArchived.dataset.on = (els.showArchived.dataset.on === 'true') ? 'false' : 'true';
      refreshArchivedToggle();
      renderList();
    };
    // set correct icon on load
    refreshArchivedToggle();
  }
  

  // live updates
  ['title','category','link','infl','pitch','notes','problem','money','image'].forEach(k=>{
    if(els[k]) els[k].addEventListener('input', updateCurrent);
  });
  if(els.q){ els.q.addEventListener('input', renderList); }
  if(els.catFilter){ els.catFilter.addEventListener('change', ()=>{ idx=0; renderList(); }); }

  window.addEventListener('keydown', (e)=>{
    if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveData(); }
    
    // Arrow key navigation
    if(e.key === 'ArrowDown' || e.key === 'ArrowUp') {
      // Don't interfere if user is typing in an input/textarea
      if(document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT')) {
        return;
      }
      
      e.preventDefault();
      
      if(!filteredIdxs.length) return;
      
      if(e.key === 'ArrowDown') {
        // Move to next item
        idx = (idx + 1) % filteredIdxs.length;
      } else {
        // Move to previous item
        idx = idx <= 0 ? filteredIdxs.length - 1 : idx - 1;
      }
      
      loadCurrent(true);
    }
  });

  // initial
  refreshCounts(); renderList(); setStatus('ready');
  loadData();
  </script>
</body>
</html>
