<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="logo.png">
  <link rel="manifest" href="/app.webmanifest">

  <meta name="theme-color" content="#000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>Ideas</title>
  <style>
    :root { 
      --bg: #fafafa; 
      --fg: #111; 
      --muted: #888; 
      --card: #fff; 
      --accent: #000; 
      --ok: #22c55e; 
      --warn: #eab308; 
      --bad: #ef4444;
      --border: #e5e5e5;
      --hover: #f5f5f5;
      --radius: 12px;
      --radius-sm: 8px;
    }

    @media (prefers-color-scheme: dark) {
      :root { 
        --bg: #09090b; 
        --fg: #fafafa; 
        --muted: #71717a; 
        --card: #18181b; 
        --accent: #fff; 
        --border: #27272a;
        --hover: #27272a;
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { 
      background: var(--bg); 
      color: var(--fg); 
      font: 14px/1.5 -apple-system, BlinkMacSystemFont, 'Inter', system-ui, sans-serif;
      overflow: hidden;
    }

    /* Layout */
    .app { 
      display: grid; 
      grid-template-columns: 300px 1fr; 
      height: 100vh;
    }
    @media (max-width: 768px) { 
      .app { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .sidebar.open { display: flex; position: fixed; inset: 0; z-index: 100; width: 100%; }
    }

    /* Sidebar */
    .sidebar { 
      display: flex; 
      flex-direction: column; 
      border-right: 1px solid var(--border);
      background: var(--bg);
    }
    .sidebar-header {
      padding: 16px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
    }
    .search {
      flex: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      color: var(--fg);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }
    .search:focus { border-color: var(--accent); }
    .search::placeholder { color: var(--muted); }

    .icon-btn {
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--fg);
      cursor: pointer;
      transition: all 0.15s;
      font-size: 16px;
    }
    .icon-btn:hover { background: var(--hover); }
    .icon-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }

    .list { 
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto; 
      overflow-x: hidden;
    }
    .row {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .row:hover { background: var(--hover); }
    .row.active { background: var(--accent); color: var(--bg); }
    .row.active .row-cat { color: var(--bg); opacity: 0.7; }
    .row-content { flex: 1; min-width: 0; }
    .row-title { 
      font-weight: 500; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis;
    }
    .row-cat { 
      font-size: 12px; 
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .row-fav { font-size: 12px; opacity: 0.8; }

    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pill {
      font-size: 11px;
      padding: 4px 10px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
    }
    .pill.warn { background: var(--warn); color: #000; border-color: var(--warn); }

    /* Main */
    .main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .main-header {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }
    .main-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }

    .content {
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      padding: 24px;
    }
    .content-inner {
      max-width: 640px;
      margin: 0 auto;
    }

    /* Form */
    .field { margin-bottom: 20px; }
    .field-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input, .field textarea {
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      color: var(--fg);
      font: inherit;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
      resize: vertical;
    }
    .field input:focus, .field textarea:focus {
      border-color: var(--accent);
    }
    .field input::placeholder, .field textarea::placeholder {
      color: var(--muted);
    }
    .title-input {
      font-size: 24px !important;
      font-weight: 600 !important;
      border: none !important;
      background: transparent !important;
      padding: 0 !important;
    }
    .title-input:focus { outline: none; }

    .add-field-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--card);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .add-field-btn:hover {
      border-color: var(--accent);
      color: var(--fg);
    }

    /* Menu dropdown */
    .menu-container { position: relative; }
    .menu {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 6px;
      min-width: 200px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
    }
    .menu.open { display: block; }
    .menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      transition: background 0.1s;
    }
    .menu-item:hover { background: var(--hover); }
    .menu-item .kbd {
      margin-left: auto;
      font-size: 11px;
      color: var(--muted);
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .menu-divider {
      height: 1px;
      background: var(--border);
      margin: 6px 0;
    }
    .menu-item.danger { color: var(--bad); }
    .menu-item.danger:hover { background: rgba(239,68,68,0.1); }

    /* Field picker dropdown */
    .field-picker {
      position: absolute;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 6px;
      min-width: 180px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
    }
    .field-picker.open { display: block; }
    .field-picker-item {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      transition: background 0.1s;
    }
    .field-picker-item:hover { background: var(--hover); }
    .field-picker-item.disabled { opacity: 0.4; pointer-events: none; }

    /* Command palette */
    .palette-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 15vh;
    }
    .palette-overlay.open { display: flex; }
    .palette {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .palette input {
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-bottom: 1px solid var(--border);
      background: transparent;
      color: var(--fg);
      font-size: 16px;
      outline: none;
    }
    .palette input::placeholder { color: var(--muted); }
    .palette-results {
      max-height: 300px;
      overflow-y: auto;
    }
    .palette-item {
      padding: 12px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.1s;
    }
    .palette-item:hover, .palette-item.selected { background: var(--hover); }
    .palette-item .icon { font-size: 16px; opacity: 0.6; }
    .palette-item .label { flex: 1; }
    .palette-item .kbd {
      font-size: 11px;
      color: var(--muted);
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Category filter */
    .cat-filter {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      color: var(--fg);
      font-size: 13px;
      outline: none;
      cursor: pointer;
      max-width: 120px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--fg);
      color: var(--bg);
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      z-index: 3000;
      transition: transform 0.3s ease;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Hidden */
    .hidden { display: none !important; }

    /* Status indicator */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--ok);
    }
    .status-dot.dirty { background: var(--warn); }

    /* Archive badge */
    .archive-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--muted);
      color: var(--bg);
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
    }

    /* Mobile menu button */
    .mobile-menu-btn {
      display: none;
    }
    @media (max-width: 768px) {
      .mobile-menu-btn { display: flex; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <input type="text" class="search" id="search" placeholder="Search ideas... ‚åòK" />
        <button class="icon-btn" id="newBtn" title="New idea (N)">+</button>
        <div class="menu-container">
          <button class="icon-btn" id="menuBtn" title="Menu">‚ò∞</button>
          <div class="menu" id="mainMenu">
          <div class="menu-item" id="menuNew"><span>‚ûï</span> New idea <span class="kbd">N</span></div>
          <div class="menu-item" id="menuDup"><span>üìã</span> Duplicate <span class="kbd">D</span></div>
          <div class="menu-item" id="menuArchive"><span>üì¶</span> Archive <span class="kbd">E</span></div>
          <div class="menu-divider"></div>
          <div class="menu-item" id="menuRandom"><span>üé≤</span> Random pick <span class="kbd">R</span></div>
          <div class="menu-item" id="menuFavToggle"><span>‚ù§Ô∏è</span> Toggle favorite <span class="kbd">F</span></div>
          <div class="menu-divider"></div>
          <div class="menu-item" id="menuImport"><span>üì•</span> Import JSON <span class="kbd">‚åòI</span></div>
          <div class="menu-item" id="menuExport"><span>üì§</span> Export JSON <span class="kbd">‚åòE</span></div>
          <div class="menu-divider"></div>
          <div class="menu-item" id="menuSettings"><span>‚öôÔ∏è</span> Settings</div>
          <div class="menu-divider"></div>
          <div class="menu-item danger" id="menuDelete"><span>üóëÔ∏è</span> Delete <span class="kbd">‚å´</span></div>
          </div>
        </div>
      </div>

      <div style="padding: 8px 16px; display: flex; gap: 6px; border-bottom: 1px solid var(--border);">
        <select class="cat-filter" id="catFilter"><option value="">All</option></select>
        <button class="icon-btn" id="favOnly" title="Favorites only">‚ô°</button>
        <button class="icon-btn" id="showArchived" title="Show archived">üì¶</button>
      </div>

      <div class="list" id="list"></div>

      <div class="sidebar-footer">
        <span class="pill"><span id="countActive">0</span> ideas</span>
        <span class="pill" id="unsavedPill" style="display:none"><span id="unsaved">0</span> unsaved</span>
        <span class="pill" id="archivedPill"><span id="countArchived">0</span> archived</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="main-header">
        <button class="icon-btn mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
        <div id="statusDot" class="status-dot" title="All saved"></div>
        <span id="statusText" style="font-size: 12px; color: var(--muted);">Ready</span>
        <div class="main-actions">
          <button class="icon-btn" id="favBtn" title="Toggle favorite (F)">‚ô°</button>
          <button class="icon-btn" id="archiveBtn" title="Archive (E)">üì¶</button>
          <button class="icon-btn" id="dupBtn" title="Duplicate (D)">üìã</button>
          <button class="icon-btn" id="saveBtn" title="Save (‚åòS)">üíæ</button>
        </div>
      </div>

      <div class="content">
        <div class="content-inner" id="formContent">
          <div class="field">
            <input type="text" class="title-input" id="title" placeholder="Untitled idea" />
          </div>

          <div class="field">
            <div class="field-label">Category</div>
            <input type="text" id="category" placeholder="app / game / product / ..." />
          </div>

          <div class="field" id="fieldNotes">
            <div class="field-label">Notes</div>
            <textarea id="notes" rows="4" placeholder="Freeform notes..."></textarea>
          </div>

          <div class="field hidden" id="fieldPitch">
            <div class="field-label">Elevator Pitch</div>
            <textarea id="pitch" rows="3" placeholder="One or two sentences that captures the hook..."></textarea>
          </div>

          <div class="field hidden" id="fieldProblem">
            <div class="field-label">Problem</div>
            <textarea id="problem" rows="3" placeholder="What pain does it remove?"></textarea>
          </div>

          <div class="field hidden" id="fieldMoney">
            <div class="field-label">Monetization</div>
            <textarea id="money" rows="3" placeholder="How does it make money?"></textarea>
          </div>

          <div class="field hidden" id="fieldInfl">
            <div class="field-label">Inflection Point</div>
            <input type="text" id="infl" placeholder="What makes it pop?" />
          </div>

          <div class="field hidden" id="fieldLink">
            <div class="field-label">Link</div>
            <input type="text" id="link" placeholder="https://..." />
          </div>

          <div class="field hidden" id="fieldImage">
            <div class="field-label">Image URL</div>
            <input type="text" id="image" placeholder="https://..." />
          </div>

          <div style="position: relative; display: inline-block;">
            <button class="add-field-btn" id="addFieldBtn">+ Add field</button>
            <div class="field-picker" id="fieldPicker">
              <div class="field-picker-item" data-field="pitch">Elevator Pitch</div>
              <div class="field-picker-item" data-field="problem">Problem</div>
              <div class="field-picker-item" data-field="money">Monetization</div>
              <div class="field-picker-item" data-field="infl">Inflection Point</div>
              <div class="field-picker-item" data-field="link">Link</div>
              <div class="field-picker-item" data-field="image">Image URL</div>
            </div>
          </div>

          <div id="archivedTag" class="archive-badge hidden" style="margin-top: 20px;">Archived</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Command Palette -->
  <div class="palette-overlay" id="paletteOverlay">
    <div class="palette">
      <input type="text" id="paletteInput" placeholder="Type a command or search..." />
      <div class="palette-results" id="paletteResults"></div>
    </div>
  </div>

  <!-- Settings Modal (hidden by default) -->
  <div class="palette-overlay" id="settingsOverlay">
    <div class="palette" style="padding: 20px;">
      <h3 style="margin-bottom: 16px;">Settings</h3>
      <div class="field">
        <div class="field-label">Endpoint URL</div>
        <input type="text" id="endpoint" placeholder="https://api.npoint.io/..." />
      </div>
      <div class="field">
        <div class="field-label">API Key (optional)</div>
        <input type="text" id="apikey" placeholder="Bearer token for write access" />
      </div>
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button class="icon-btn" style="width: auto; padding: 0 16px;" id="saveSettings">Save</button>
        <button class="icon-btn" style="width: auto; padding: 0 16px;" id="closeSettings">Cancel</button>
        <button class="icon-btn" style="width: auto; padding: 0 16px;" id="reloadData">Reload Data</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" accept="application/json" style="display: none;" />

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
  // ---- Utilities ----
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = () => crypto?.randomUUID?.().slice(0,8) || Math.random().toString(36).slice(2,10);
  const nowSec = () => Math.floor(Date.now()/1000);

  // Config
  const cfg = {
    endpoint: localStorage.getItem('ih.endpoint') || 'https://api.npoint.io/cd1184765c36929f0b34',
    apikey: localStorage.getItem('ih.apikey') || ''
  };

  const STORAGE_KEY = 'ih.local.ideas.v1';

  // ---- State ----
  let data = { ideas: [] };
  let idx = -1;
  let filteredIdxs = [];
  let dirty = new Set();
  let recentPicks = new Set();

  // ---- Elements ----
  const els = {
    search: $('#search'),
    list: $('#list'),
    catFilter: $('#catFilter'),
    title: $('#title'),
    category: $('#category'),
    notes: $('#notes'),
    pitch: $('#pitch'),
    problem: $('#problem'),
    money: $('#money'),
    infl: $('#infl'),
    link: $('#link'),
    image: $('#image'),
    statusDot: $('#statusDot'),
    statusText: $('#statusText'),
    toast: $('#toast'),
    unsaved: $('#unsaved'),
    unsavedPill: $('#unsavedPill'),
    countActive: $('#countActive'),
    countArchived: $('#countArchived'),
    archivedTag: $('#archivedTag'),
    favBtn: $('#favBtn'),
    favOnly: $('#favOnly'),
    showArchived: $('#showArchived'),
    mainMenu: $('#mainMenu'),
    fieldPicker: $('#fieldPicker'),
    paletteOverlay: $('#paletteOverlay'),
    paletteInput: $('#paletteInput'),
    paletteResults: $('#paletteResults'),
    settingsOverlay: $('#settingsOverlay'),
    endpoint: $('#endpoint'),
    apikey: $('#apikey'),
    fileInput: $('#fileInput'),
    sidebar: $('#sidebar')
  };

  // Load config into settings
  if(els.endpoint) els.endpoint.value = cfg.endpoint;
  if(els.apikey) els.apikey.value = cfg.apikey;

  // ---- Toast ----
  let toastTimeout;
  function showToast(msg) {
    els.toast.textContent = msg;
    els.toast.classList.add('show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => els.toast.classList.remove('show'), 2500);
  }

  // ---- Data normalization ----
  function expandIdea(raw) {
    const compact = raw.hasOwnProperty('t') || raw.hasOwnProperty('ca');
    if(compact) {
      return {
        id: raw.id || uid(),
        title: raw.t ?? '',
        category: raw.c ?? null,
        pitch: raw.p ?? null,
        notes: raw.n ?? null,
        problem: raw.pr ?? null,
        monetization: raw.m ?? null,
        link: raw.l ?? null,
        image: raw.i ?? null,
        inflection_point: raw.ip ?? null,
        createdAt: raw.ca || nowSec(),
        updatedAt: raw.ua || nowSec(),
        archived: !!raw.a,
        score: Number.isFinite(raw.s) ? raw.s : 0,
        fav: !!raw.f
      };
    }
    return {
      id: raw.id || uid(),
      title: raw.title ?? '',
      category: raw.category ?? null,
      pitch: raw.pitch ?? null,
      notes: raw.notes ?? null,
      problem: raw.problem ?? null,
      monetization: raw.monetization ?? raw.money ?? null,
      link: raw.link ?? null,
      image: raw.image ?? null,
      inflection_point: raw.inflection_point ?? raw.infl ?? null,
      createdAt: raw.createdAt || nowSec(),
      updatedAt: raw.updatedAt || nowSec(),
      archived: !!raw.archived,
      score: Number.isFinite(raw.score) ? raw.score : 0,
      fav: !!raw.fav
    };
  }

  function normalizeIdea(p) {
    return {
      id: p.id || uid(),
      title: p.title ?? '',
      category: p.category ?? null,
      pitch: p.pitch ?? null,
      notes: p.notes ?? null,
      problem: p.problem ?? null,
      monetization: p.monetization ?? p.money ?? null,
      link: p.link ?? null,
      image: p.image ?? null,
      inflection_point: p.inflection_point ?? p.infl ?? null,
      createdAt: p.createdAt || nowSec(),
      updatedAt: nowSec(),
      archived: !!p.archived,
      score: Number.isFinite(p.score) ? p.score : 0,
      fav: !!p.fav
    };
  }

  function toCompact(it) {
    const o = {
      id: it.id,
      t: (it.title ?? '').trim() || undefined,
      c: it.category?.trim() || undefined,
      p: it.pitch?.trim() || undefined,
      n: it.notes?.trim() || undefined,
      pr: it.problem?.trim() || undefined,
      m: it.monetization?.trim() || undefined,
      l: it.link?.trim() || undefined,
      i: it.image?.trim() || undefined,
      ip: it.inflection_point?.trim() || undefined,
      ca: it.createdAt || nowSec(),
      ua: nowSec(),
      a: it.archived ? 1 : undefined,
      s: it.score || undefined,
      f: it.fav ? 1 : undefined
    };
    Object.keys(o).forEach(k => { if(o[k] === undefined || o[k] === '') delete o[k]; });
    return o;
  }

  // ---- Status ----
  function setStatus(msg) {
    if(els.statusText) els.statusText.textContent = msg;
  }

  function refreshCounts() {
    const total = data.ideas.length;
    const archived = data.ideas.filter(it => it.archived).length;
    const active = total - archived;

    if(els.countActive) els.countActive.textContent = active;
    if(els.countArchived) els.countArchived.textContent = archived;
    if(els.unsaved) els.unsaved.textContent = dirty.size;
    if(els.unsavedPill) els.unsavedPill.style.display = dirty.size ? 'inline' : 'none';
    if(els.statusDot) els.statusDot.classList.toggle('dirty', dirty.size > 0);
    if(els.statusDot) els.statusDot.title = dirty.size ? `${dirty.size} unsaved` : 'All saved';
  }

  // ---- Field visibility ----
  const optionalFields = ['pitch', 'problem', 'money', 'infl', 'link', 'image'];
  const fieldMap = {
    pitch: { el: 'fieldPitch', data: 'pitch' },
    problem: { el: 'fieldProblem', data: 'problem' },
    money: { el: 'fieldMoney', data: 'monetization' },
    infl: { el: 'fieldInfl', data: 'inflection_point' },
    link: { el: 'fieldLink', data: 'link' },
    image: { el: 'fieldImage', data: 'image' }
  };

  function updateFieldVisibility(idea) {
    optionalFields.forEach(f => {
      const cfg = fieldMap[f];
      const el = $(`#${cfg.el}`);
      const hasValue = idea && idea[cfg.data]?.trim();
      if(el) el.classList.toggle('hidden', !hasValue);
    });
    updateFieldPickerState();
  }

  function showField(fieldKey) {
    const cfg = fieldMap[fieldKey];
    if(!cfg) return;
    const el = $(`#${cfg.el}`);
    if(el) {
      el.classList.remove('hidden');
      const input = el.querySelector('input, textarea');
      if(input) input.focus();
    }
    updateFieldPickerState();
  }

  function updateFieldPickerState() {
    $$('.field-picker-item').forEach(item => {
      const f = item.dataset.field;
      const cfg = fieldMap[f];
      const el = $(`#${cfg.el}`);
      const isVisible = el && !el.classList.contains('hidden');
      item.classList.toggle('disabled', isVisible);
    });
  }

  // ---- Render list ----
  function renderList() {
    const q = (els.search?.value || '').toLowerCase().trim();
    const cat = els.catFilter?.value || '';
    const favOnly = els.favOnly?.classList.contains('active');
    const showArchived = els.showArchived?.classList.contains('active');

    // Update categories
    if(els.catFilter) {
      const cats = new Set(['']);
      data.ideas.forEach(it => { if(it.category) cats.add(it.category); });
      const prevSel = els.catFilter.value;
      els.catFilter.innerHTML = '<option value="">All</option>';
      cats.forEach(c => {
        if(c) {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          els.catFilter.appendChild(opt);
        }
      });
      els.catFilter.value = prevSel;
    }

    const nodes = [];
    filteredIdxs = [];

    data.ideas.forEach((it, i) => {
      if(!showArchived && it.archived) return;
      if(cat && it.category !== cat) return;
      if(favOnly && !it.fav) return;
      if(q && !(`${it.title} ${it.notes||''}`.toLowerCase().includes(q))) return;

      filteredIdxs.push(i);
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.i = String(filteredIdxs.length - 1);
      if(idx === filteredIdxs.length - 1) row.classList.add('active');

      row.innerHTML = `
        <div class="row-content">
          <div class="row-title">${escapeHtml(it.title || 'Untitled')}</div>
          <div class="row-cat">${escapeHtml(it.category || '')}</div>
        </div>
        ${it.fav ? '<span class="row-fav">‚ù§Ô∏è</span>' : ''}
      `;
      row.onclick = () => { idx = Number(row.dataset.i); loadCurrent(); };
      nodes.push(row);
    });

    if(els.list) els.list.replaceChildren(...nodes);
    if(idx < 0 && filteredIdxs.length) idx = 0;
    if(filteredIdxs.length && idx >= filteredIdxs.length) idx = filteredIdxs.length - 1;

    recentPicks.clear();
    loadCurrent(false);
  }

  function loadCurrent(scrollIntoView = true) {
    if(idx < 0 || !filteredIdxs.length) { clearForm(); return; }

    const realIndex = filteredIdxs[idx];
    const it = data.ideas[realIndex];

    els.title.value = it.title || '';
    els.category.value = it.category || '';
    els.notes.value = it.notes || '';
    els.pitch.value = it.pitch || '';
    els.problem.value = it.problem || '';
    els.money.value = it.monetization || '';
    els.infl.value = it.inflection_point || '';
    els.link.value = it.link || '';
    els.image.value = it.image || '';

    if(els.archivedTag) els.archivedTag.classList.toggle('hidden', !it.archived);
    if(els.favBtn) els.favBtn.classList.toggle('active', it.fav);
    if(els.favBtn) els.favBtn.textContent = it.fav ? '‚ù§Ô∏è' : '‚ô°';

    updateFieldVisibility(it);

    $$('.row').forEach((n, j) => {
      n.classList.toggle('active', j === idx);
      if(j === idx && scrollIntoView) n.scrollIntoView({ block: 'nearest' });
    });
  }

  function clearForm() {
    ['title', 'category', 'notes', 'pitch', 'problem', 'money', 'infl', 'link', 'image'].forEach(k => {
      if(els[k]) els[k].value = '';
    });
    if(els.archivedTag) els.archivedTag.classList.add('hidden');
    if(els.favBtn) { els.favBtn.classList.remove('active'); els.favBtn.textContent = '‚ô°'; }
    optionalFields.forEach(f => {
      const el = $(`#${fieldMap[f].el}`);
      if(el) el.classList.add('hidden');
    });
  }

  function readForm() {
    const base = filteredIdxs[idx] != null ? data.ideas[filteredIdxs[idx]] || {} : {};
    return normalizeIdea({
      id: base.id,
      title: els.title?.value || '',
      category: els.category?.value || '',
      notes: els.notes?.value || '',
      pitch: els.pitch?.value || '',
      problem: els.problem?.value || '',
      monetization: els.money?.value || '',
      inflection_point: els.infl?.value || '',
      link: els.link?.value || '',
      image: els.image?.value || '',
      archived: base.archived || false,
      createdAt: base.createdAt,
      score: base.score || 0,
      fav: base.fav || false
    });
  }

  function updateCurrent() {
    if(idx < 0 || !filteredIdxs.length) return;
    const realIndex = filteredIdxs[idx];
    data.ideas[realIndex] = readForm();
    dirty.add(data.ideas[realIndex].id);
    refreshCounts();
    if(document.activeElement !== els.title) renderList();
  }

  // ---- Actions ----
  function newIdea() {
    const it = normalizeIdea({ title: '', category: '', notes: '' });
    data.ideas.unshift(it);
    idx = 0;
    filteredIdxs = [0, ...filteredIdxs.map(i => i + 1)];
    renderList();
    dirty.add(it.id);
    refreshCounts();
    els.title?.focus();
    showToast('New idea created');
  }

  function duplicateIdea() {
    if(idx < 0) return;
    const realIndex = filteredIdxs[idx];
    const it = data.ideas[realIndex];
    const copy = normalizeIdea({ ...it, id: undefined, title: it.title + ' (copy)' });
    data.ideas.splice(realIndex + 1, 0, copy);
    renderList();
    dirty.add(copy.id);
    refreshCounts();
    showToast('Idea duplicated');
  }

  function archiveIdea() {
    if(idx < 0) return;
    const realIndex = filteredIdxs[idx];
    data.ideas[realIndex].archived = !data.ideas[realIndex].archived;
    data.ideas[realIndex].updatedAt = nowSec();
    dirty.add(data.ideas[realIndex].id);
    renderList();
    refreshCounts();
    showToast(data.ideas[realIndex].archived ? 'Archived' : 'Unarchived');
  }

  function deleteIdea() {
    if(idx < 0) return;
    if(!confirm('Delete this idea?')) return;
    const realIndex = filteredIdxs[idx];
    const id = data.ideas[realIndex].id;
    data.ideas.splice(realIndex, 1);
    idx = Math.max(0, idx - 1);
    dirty.delete(id);
    renderList();
    refreshCounts();
    showToast('Deleted');
  }

  function toggleFav() {
    if(idx < 0) return;
    const realIndex = filteredIdxs[idx];
    const it = data.ideas[realIndex];
    it.fav = !it.fav;
    it.updatedAt = nowSec();
    dirty.add(it.id);
    if(els.favBtn) {
      els.favBtn.classList.toggle('active', it.fav);
      els.favBtn.textContent = it.fav ? '‚ù§Ô∏è' : '‚ô°';
    }
    refreshCounts();
    renderList();
    showToast(it.fav ? 'Added to favorites' : 'Removed from favorites');
  }

  function randomPick() {
    if(!filteredIdxs.length) return;
    const newIdx = filteredIdxs[Math.floor(Math.random() * filteredIdxs.length)];
    idx = filteredIdxs.indexOf(newIdx);
    if(idx === -1) idx = 0;
    loadCurrent();
    showToast('Random pick!');
  }

  // ---- I/O ----
  async function loadData() {
    const ep = cfg.endpoint?.trim();
    if(ep) {
      try {
        setStatus('Loading...');
        const res = await fetch(ep, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        const arr = Array.isArray(json.ideas) ? json.ideas : Array.isArray(json) ? json : [];
        data = { ideas: arr.map(x => normalizeIdea(expandIdea(x))) };
        dirty.clear();
        refreshCounts();
        idx = -1;
        renderList();
        setStatus('Loaded');
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ ideas: data.ideas.map(toCompact) })); } catch(e) {}
        return;
      } catch(e) {
        console.error(e);
        setStatus('Load failed, using local');
      }
    }

    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : { ideas: [] };
      const arr = Array.isArray(parsed.ideas) ? parsed.ideas : Array.isArray(parsed) ? parsed : [];
      data = { ideas: arr.map(x => normalizeIdea(expandIdea(x))) };
    } catch(e) {
      data = { ideas: [] };
    }
    dirty.clear();
    refreshCounts();
    idx = -1;
    renderList();
    setStatus('Loaded (local)');
  }

  async function saveData() {
    if(!data.ideas.length) { showToast('Nothing to save'); return; }
    if(!dirty.size) { showToast('No changes'); return; }

    const payload = { ideas: data.ideas.map(toCompact) };
    const ep = cfg.endpoint?.trim();

    if(ep) {
      try {
        setStatus('Saving...');
        const headers = { 'Content-Type': 'application/json' };
        if(cfg.apikey) headers['Authorization'] = 'Bearer ' + cfg.apikey;
        const res = await fetch(ep, { method: 'POST', headers, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        dirty.clear();
        refreshCounts();
        setStatus('Saved');
        showToast('Saved!');
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); } catch(e) {}
        return;
      } catch(e) {
        console.error(e);
        setStatus('Save failed, saved locally');
      }
    }

    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); } catch(e) {}
    dirty.clear();
    refreshCounts();
    setStatus('Saved locally');
    showToast('Saved locally');
  }

  function exportJSON() {
    const blob = new Blob([JSON.stringify({ ideas: data.ideas.map(toCompact) }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ideas.json';
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('Exported');
  }

  function importJSON(file) {
    const r = new FileReader();
    r.onload = () => {
      try {
        const j = JSON.parse(r.result);
        const arr = Array.isArray(j.ideas) ? j.ideas : Array.isArray(j) ? j : [];
        arr.forEach(x => data.ideas.push(normalizeIdea(expandIdea(x))));
        renderList();
        refreshCounts();
        showToast(`Imported ${arr.length} ideas`);
      } catch(e) {
        alert('Invalid JSON');
      }
    };
    r.readAsText(file);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
  }

  // ---- Command Palette ----
  const commands = [
    { id: 'new', label: 'New idea', icon: '‚ûï', key: 'N', action: newIdea },
    { id: 'dup', label: 'Duplicate', icon: 'üìã', key: 'D', action: duplicateIdea },
    { id: 'archive', label: 'Archive', icon: 'üì¶', key: 'E', action: archiveIdea },
    { id: 'delete', label: 'Delete', icon: 'üóëÔ∏è', key: '‚å´', action: deleteIdea },
    { id: 'fav', label: 'Toggle favorite', icon: '‚ù§Ô∏è', key: 'F', action: toggleFav },
    { id: 'random', label: 'Random pick', icon: 'üé≤', key: 'R', action: randomPick },
    { id: 'save', label: 'Save', icon: 'üíæ', key: '‚åòS', action: saveData },
    { id: 'import', label: 'Import JSON', icon: 'üì•', key: '‚åòI', action: () => els.fileInput.click() },
    { id: 'export', label: 'Export JSON', icon: 'üì§', key: '‚åòE', action: exportJSON },
    { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è', action: openSettings },
  ];

  let paletteIdx = 0;
  let filteredCommands = commands;

  function openPalette() {
    els.paletteOverlay.classList.add('open');
    els.paletteInput.value = '';
    els.paletteInput.focus();
    filteredCommands = commands;
    paletteIdx = 0;
    renderPalette();
  }

  function closePalette() {
    els.paletteOverlay.classList.remove('open');
  }

  function renderPalette() {
    const q = els.paletteInput.value.toLowerCase();
    filteredCommands = commands.filter(c => c.label.toLowerCase().includes(q));
    if(paletteIdx >= filteredCommands.length) paletteIdx = Math.max(0, filteredCommands.length - 1);

    els.paletteResults.innerHTML = filteredCommands.map((c, i) => `
      <div class="palette-item ${i === paletteIdx ? 'selected' : ''}" data-idx="${i}">
        <span class="icon">${c.icon}</span>
        <span class="label">${c.label}</span>
        ${c.key ? `<span class="kbd">${c.key}</span>` : ''}
      </div>
    `).join('');

    $$('.palette-item').forEach(el => {
      el.onclick = () => {
        const cmd = filteredCommands[Number(el.dataset.idx)];
        if(cmd) { closePalette(); cmd.action(); }
      };
    });
  }

  function openSettings() {
    els.settingsOverlay.classList.add('open');
  }

  function closeSettings() {
    els.settingsOverlay.classList.remove('open');
  }

  // ---- Event wiring ----
  // Menu toggle
  $('#menuBtn').onclick = () => els.mainMenu.classList.toggle('open');
  document.addEventListener('click', e => {
    if(!e.target.closest('.menu-container') && !e.target.closest('#menuBtn')) {
      els.mainMenu.classList.remove('open');
    }
  });

  // Field picker
  $('#addFieldBtn').onclick = () => els.fieldPicker.classList.toggle('open');
  document.addEventListener('click', e => {
    if(!e.target.closest('#addFieldBtn') && !e.target.closest('.field-picker')) {
      els.fieldPicker.classList.remove('open');
    }
  });
  $$('.field-picker-item').forEach(item => {
    item.onclick = () => {
      showField(item.dataset.field);
      els.fieldPicker.classList.remove('open');
    };
  });

  // Menu actions
  $('#menuNew').onclick = () => { els.mainMenu.classList.remove('open'); newIdea(); };
  $('#menuDup').onclick = () => { els.mainMenu.classList.remove('open'); duplicateIdea(); };
  $('#menuArchive').onclick = () => { els.mainMenu.classList.remove('open'); archiveIdea(); };
  $('#menuDelete').onclick = () => { els.mainMenu.classList.remove('open'); deleteIdea(); };
  $('#menuRandom').onclick = () => { els.mainMenu.classList.remove('open'); randomPick(); };
  $('#menuFavToggle').onclick = () => { els.mainMenu.classList.remove('open'); toggleFav(); };
  $('#menuImport').onclick = () => { els.mainMenu.classList.remove('open'); els.fileInput.click(); };
  $('#menuExport').onclick = () => { els.mainMenu.classList.remove('open'); exportJSON(); };
  $('#menuSettings').onclick = () => { els.mainMenu.classList.remove('open'); openSettings(); };

  // Header actions
  $('#newBtn').onclick = newIdea;
  $('#favBtn').onclick = toggleFav;
  $('#archiveBtn').onclick = archiveIdea;
  $('#dupBtn').onclick = duplicateIdea;
  $('#saveBtn').onclick = saveData;

  // Filters
  els.favOnly.onclick = () => { els.favOnly.classList.toggle('active'); renderList(); };
  els.showArchived.onclick = () => { els.showArchived.classList.toggle('active'); renderList(); };
  els.catFilter.onchange = () => { idx = 0; renderList(); };
  els.search.oninput = renderList;

  // Form inputs
  ['title', 'category', 'notes', 'pitch', 'problem', 'money', 'infl', 'link', 'image'].forEach(k => {
    if(els[k]) els[k].addEventListener('input', updateCurrent);
  });

  // Settings
  $('#saveSettings').onclick = () => {
    cfg.endpoint = els.endpoint.value.trim();
    cfg.apikey = els.apikey.value.trim();
    localStorage.setItem('ih.endpoint', cfg.endpoint);
    localStorage.setItem('ih.apikey', cfg.apikey);
    closeSettings();
    showToast('Settings saved');
  };
  $('#closeSettings').onclick = closeSettings;
  $('#reloadData').onclick = () => { closeSettings(); loadData(); };

  // File input
  els.fileInput.onchange = () => { if(els.fileInput.files[0]) importJSON(els.fileInput.files[0]); };

  // Palette
  els.paletteInput.oninput = () => { paletteIdx = 0; renderPalette(); };
  els.paletteOverlay.onclick = e => { if(e.target === els.paletteOverlay) closePalette(); };
  els.settingsOverlay.onclick = e => { if(e.target === els.settingsOverlay) closeSettings(); };

  // Mobile sidebar
  $('#mobileMenuBtn').onclick = () => els.sidebar.classList.toggle('open');

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    const inInput = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName);

    // Command palette
    if((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openPalette();
      return;
    }

    // Palette navigation
    if(els.paletteOverlay.classList.contains('open')) {
      if(e.key === 'Escape') { closePalette(); return; }
      if(e.key === 'ArrowDown') { e.preventDefault(); paletteIdx = Math.min(paletteIdx + 1, filteredCommands.length - 1); renderPalette(); return; }
      if(e.key === 'ArrowUp') { e.preventDefault(); paletteIdx = Math.max(paletteIdx - 1, 0); renderPalette(); return; }
      if(e.key === 'Enter') { e.preventDefault(); if(filteredCommands[paletteIdx]) { closePalette(); filteredCommands[paletteIdx].action(); } return; }
      return;
    }

    // Settings escape
    if(els.settingsOverlay.classList.contains('open') && e.key === 'Escape') {
      closeSettings();
      return;
    }

    // Global shortcuts
    if((e.metaKey || e.ctrlKey) && e.key === 's') { e.preventDefault(); saveData(); return; }
    if((e.metaKey || e.ctrlKey) && e.key === 'i') { e.preventDefault(); els.fileInput.click(); return; }
    if((e.metaKey || e.ctrlKey) && e.key === 'e') { e.preventDefault(); exportJSON(); return; }

    // Non-input shortcuts
    if(!inInput) {
      if(e.key === 'n' || e.key === 'N') { e.preventDefault(); newIdea(); return; }
      if(e.key === 'd' || e.key === 'D') { e.preventDefault(); duplicateIdea(); return; }
      if(e.key === 'e' || e.key === 'E') { e.preventDefault(); archiveIdea(); return; }
      if(e.key === 'f' || e.key === 'F') { e.preventDefault(); toggleFav(); return; }
      if(e.key === 'r' || e.key === 'R') { e.preventDefault(); randomPick(); return; }
      if(e.key === 'Backspace' || e.key === 'Delete') { e.preventDefault(); deleteIdea(); return; }

      // Arrow navigation
      if(e.key === 'ArrowDown') { e.preventDefault(); idx = Math.min(idx + 1, filteredIdxs.length - 1); loadCurrent(); return; }
      if(e.key === 'ArrowUp') { e.preventDefault(); idx = Math.max(idx - 1, 0); loadCurrent(); return; }
    }
  });

  // Init
  refreshCounts();
  renderList();
  loadData();
  </script>
</body>
</html>
